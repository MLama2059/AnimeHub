@using AnimeHubClient.Services
@inject IAnimeService AnimeService
@if (IsLoading)
{
    <MudPaper Class="pa-4 d-flex flex-column align-center justify-center" Style="width: 280px; height: 180px;">
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Small" />
        <MudText Typo="Typo.caption" Class="mt-2">Fetching details...</MudText>
    </MudPaper>
}
else if (Anime != null)
{
    <MudPaper Class="pa-4 quick-view-content" Style="width: 280px; border-radius: 10px;">
        <div class="d-flex justify-content-between align-items-center mb-1">
            <MudText Typo="Typo.body1" Class="fw-bold">@Anime.Season @Anime.PremieredYear</MudText>
            <div class="d-flex align-items-center">
                <MudIcon Icon="@Icons.Material.Filled.Star" Color="Color.Primary" Size="Size.Small" Class="me-1" />
                <MudText Typo="Typo.subtitle2" Class="fw-bold">@Anime.Rating</MudText>
            </div>
        </div>

        @if (Anime.Studios != null && Anime.Studios.Any())
        {
            @foreach (var studio in Anime.Studios)
            {
                <MudText Typo="Typo.caption" Color="Color.Error" Class="fw-bold mb-2 d-block">@studio</MudText>
            }
        }
        else
        {
            <MudText Typo="Typo.caption" Color="Color.Error" Class="fw-bold mb-2 d-block">N/A</MudText>
        }

        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-3">@Anime.CategoryName  •  @Anime.Episodes</MudText>

        <MudChipSet T="Color" Class="mb-4">
            @if (Anime.Genres != null && Anime.Genres.Any())
            {
                @foreach (var genre in Anime.Genres.Take(3))
                {
                    <MudChip Text="@genre" Size="Size.Small" Color="Color.Primary" Variant="Variant.Filled" />
                }
            }
            else
            {
                <MudText Typo="Typo.body2">N/A</MudText>
            }
        </MudChipSet>
    </MudPaper>
}

@code {
    [Parameter] public int AnimeId { get; set; }
    private AnimeReadDto? Anime { get; set; }
    private bool IsLoading { get; set; } = false;

    protected override async Task OnParametersSetAsync()
    {
        if (Anime == null && !IsLoading)
        {
            await LoadAnime();
        }
    }

    private async Task LoadAnime()
    {
        IsLoading = true;
        try
        {
            Anime = await AnimeService.GetAnimeByIdAsync(AnimeId);
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error fetching anime details: {ex.Message}");
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }
}
