@page "/anime/{Id:int}"
@using AnimeHub.Shared.Models.Enums
@using AnimeHubClient.Services
@using Microsoft.AspNetCore.Components.Authorization
@using AnimeHubClient.Extensions
@inject IAnimeService AnimeService
@inject IWatchlistService WatchlistService
@inject IConfiguration Configuration
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthenticationStateProvider

@if (IsLoading)
{
    <div class="py-4 text-center"><MudProgressCircular Indeterminate="true" /></div>
}
else if (Anime == null)
{
    <MudAlert Severity="Severity.Error" Class="mt-5">
        <MudText Typo="Typo.h5">Anime Not Found</MudText>
        <MudText>The requested anime ID (@Id) could not be retrieved.</MudText>
    </MudAlert>
}
else
{
    <MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-5">
        <MudGrid Spacing="4">
            @* --- Left Column: Image and Details --- *@
            <MudItem xs="12" md="4" lg="3">
                <MudPaper Elevation="8" Class="pa-2">
                    <img src="@(Configuration["ApiBaseUrl"]?.ToString() + Anime.ImageUrl)" alt="@Anime.Title" style="width:100%; height:auto; border-radius:4px;" />
                </MudPaper>

                @* Watchlist UI block *@
                <div class="d-flex gap-2 mt-4 mb-4">
                    @if (!IsAuthenticated)
                    {
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Login" FullWidth="true" OnClick="NavigateToLogin">
                            Log In to Add
                        </MudButton>
                    }
                    else
                    {
                        <MudButtonGroup Color="@(CurrentWatchStatus.HasValue ? Color.Info : Color.Primary)"
                                        Variant="Variant.Filled"
                                        FullWidth="true"
                                        Class="flex-grow-1">
                            @* Main Button Area *@
                            @if (CurrentWatchStatus.HasValue)
                            {
                                @* If Added: Shows Current Status *@
                                <MudButton Class="flex-grow-1" StartIcon="@Icons.Material.Filled.BookmarkAdded">
                                    @CurrentWatchStatus.Value.GetDisplayName()
                                </MudButton>
                            }
                            else
                            {
                                @* If Not Added: Shows "Add to Watchlist" *@
                                <MudButton Class="flex-grow-1"
                                           OnClick="AddToWatchlistDefault"
                                           StartIcon="@Icons.Material.Filled.BookmarkAdd"
                                           Disabled="@IsActionLoading">
                                    Add to Watchlist
                                </MudButton>
                            }

                            @* Dropdown Arrow Area *@
                            <MudMenu Icon="@Icons.Material.Filled.ArrowDropDown" AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight">
                                @foreach (var status in Statuses)
                                {
                                    <MudMenuItem OnClick="() => OnStatusChangeAsync(status)">
                                        <div class="d-flex align-content-center gap-2">
                                            @if (CurrentWatchStatus == status)
                                            {
                                                <MudIcon Icon="@Icons.Material.Filled.Check" Size="Size.Small" Color="Color.Success" />
                                            }
                                            else
                                            {
                                                <MudIcon Icon="@Icons.Material.Filled.Circle" Size="Size.Small" Style="opacity:0;" />
                                            }
                                            @status.GetDisplayName()
                                        </div>
                                    </MudMenuItem>
                                }
                            </MudMenu>
                        </MudButtonGroup>
                    }
                </div>

                <MudList T="string" Class="mt-4" Dense="true">
                    <MudListItem Icon="@Icons.Material.Filled.CalendarMonth">
                        <MudText Typo="Typo.subtitle1" Class="fw-bold">Premiered:</MudText>
                        @Anime.Season @Anime.PremieredYear
                    </MudListItem>
                    <MudListItem Icon="@Icons.Material.Filled.StarRate">
                        <MudText Typo="Typo.subtitle1" Class="fw-bold">Rating:</MudText>
                        @(Anime.Rating.HasValue? Anime.Rating.ToString() : "N/A")
                    </MudListItem>
                    <MudListItem Icon="@Icons.Material.Filled.Movie">
                        <MudText Typo="Typo.subtitle1" Class="fw-bold">Episodes:</MudText>
                        @(Anime.Episodes.HasValue? Anime.Episodes.ToString() : "N/A")
                    </MudListItem>
                    <MudListItem Icon="@Icons.Material.Filled.Update">
                        <MudText Typo="Typo.subtitle1" Class="fw-bold">Status:</MudText> @(((Status)Enum.Parse(typeof(Status), Anime.Status)).GetDisplayName())
                    </MudListItem>
                    <MudListItem Icon="@Icons.Material.Filled.CameraRoll">
                        <MudText Typo="Typo.subtitle1" Class="fw-bold">Studios:</MudText>
                        @if (Anime.Studios != null && Anime.Studios.Any())
                        {
                            @foreach (var studio in Anime.Studios)
                            {
                                <MudText Typo="Typo.body2">@studio</MudText>
                            }
                        }
                        else
                        {
                            <MudText Typo="Typo.body2">N/A</MudText>
                        }

                    </MudListItem>
                </MudList>
            </MudItem>

            @* --- Right Column: Header, Description, Reviews --- *@
            <MudItem xs="12" md="8" lg="9">
                <MudText Typo="Typo.h3" Class="fw-bold mb-1">@Anime.Title</MudText>
                <MudText Typo="Typo.subtitle1" Class="text-muted mb-3">@Anime.CategoryName</MudText>
                
                @* Genres Chip Group *@
                <MudText Typo="Typo.subtitle1" Class="fw-bold mb-2">Genres</MudText>
                <MudChipSet T="Color" Class="mb-4">
                    @if (Anime.Genres != null && Anime.Genres.Any())
                    {
                        @foreach (var genre in Anime.Genres)
                        {
                            <MudChip Text="@genre" Color="Color.Primary" Variant="Variant.Filled" />
                        }
                    }
                    else
                    {
                        <MudText Typo="Typo.body2">N/A</MudText>
                    }
                </MudChipSet>

                @* Trailer *@
                @if (!string.IsNullOrEmpty(Anime.TrailerUrl))
                {
                    // Use a variable to safely get the absolute URLs for trailer/poster
                    string trailerBaseUrl = Configuration["ApiBaseUrl"]?.ToString() ?? "";
                    string fullTrailerUrl = trailerBaseUrl + Anime.TrailerUrl;
                    string fullPosterUrl = trailerBaseUrl + Anime.TrailerPosterUrl;

                    <MudText Typo="Typo.h6" Class="mt-4 mb-2 fw-bold">Official Trailer</MudText>
                    <MudPaper Elevation="4" Class="mb-4 pa-1" Style="max-width: 400px;">
                        <video controls style="width: 100%; height: auto; border-radius: 4px;" poster="@fullPosterUrl">
                            <source src="@fullTrailerUrl" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>
                    </MudPaper>
                }

                <MudText Typo="Typo.h5" Class="mt-4 fw-bold">Synopsis</MudText>
                <MudDivider Class="my-2" />
                <MudText Typo="Typo.body1" Style="white-space: pre-wrap;">@Anime.Description</MudText>

                @* --- User Review Section Placeholder --- *@
                <RatingSection AnimeId="@Id" />
            </MudItem>
        </MudGrid>

        @* Recommendation Section *@
        @if (Recommendations != null && Recommendations.Any())
        {
            <MudDivider Class="my-8" />

            <div class="mb-4">
                <MudText Typo="Typo.h5" Class="fw-bold">You Might Also Like</MudText>
            </div>

            <MudGrid Spacing="3" Class="mb-8">
                @foreach (var anime in Recommendations)
                {
                    <MudItem xs="6" sm="4" md="3" lg="2">
                        <AnimeCard Anime="anime" />
                    </MudItem>
                }
            </MudGrid>
        }
    </MudContainer>
}

@code {
    [Parameter]
    public int Id { get; set; }
    private AnimeReadDto? Anime;
    private List<AnimeListReadDto> Recommendations = new();
    private WatchStatus? CurrentWatchStatus = null;
    private bool IsAuthenticated;
    private bool IsLoading { get; set; } = true;
    private bool IsActionLoading { get; set; } = false; // Separate loader for button actions

    // Enum to hold the watching statuses for the dropdown
    private List<WatchStatus> Statuses = Enum.GetValues<WatchStatus>().ToList();

    protected override async Task OnParametersSetAsync()
    {
        await LoadAnime();
    }

    private async Task LoadAnime()
    {
        IsLoading = true;
        Anime = null;
        CurrentWatchStatus = null;
        Recommendations = new();

        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        IsAuthenticated = authState.User.Identity?.IsAuthenticated ?? false;

        try
        {
            Anime = await AnimeService.GetAnimeByIdAsync(Id);
            // FETCH RECOMMENDATIONS (The Algorithm)
            Recommendations = await AnimeService.GetRecommendationsAsync(Id, 6);

            if (Anime != null && IsAuthenticated)
            {
                CurrentWatchStatus = await WatchlistService.GetWatchStatusAsync(Id);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error fetching anime details: {ex.Message}", Severity.Error);
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task AddToWatchlistDefault()
    {
        if (!IsAuthenticated) return;
        IsActionLoading = true;

        try
        {
            var success = await WatchlistService.AddToWatchlistAsync(Id);
            if (success)
            {
                CurrentWatchStatus = WatchStatus.PlanToWatch;
                Snackbar.Add("Added to watchlist!", Severity.Success);
            }
            else
            {
                Snackbar.Add("Failed to add to watchlist.", Severity.Error);
            }
        }
        finally
        {
            IsActionLoading = false;
        }
    }

    private async Task OnStatusChangeAsync(WatchStatus newStatus)
    {
        if (!IsAuthenticated) return;

        // If not in watchlist yet, Add it first, then Update status
        if (!CurrentWatchStatus.HasValue)
        {
            IsActionLoading = true;
            var addSuccess = await WatchlistService.AddToWatchlistAsync(Id);
            if (!addSuccess)
            {
                Snackbar.Add("Failed to create entry.", Severity.Error);
                IsActionLoading = false;
                return;
            }
        }
        else if (CurrentWatchStatus == newStatus)
        {
            return;
        }

        // Update the status
        IsActionLoading = true;

        try
        {
            var success = await WatchlistService.UpdateWatchStatusAsync(Id, newStatus);

            if (success)
            {
                CurrentWatchStatus = newStatus;
                Snackbar.Add($"Watch status updated to {newStatus}!", Severity.Success);
            }
            else
            {
                Snackbar.Add("Failed to update status.", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error updating status: {ex.Message}", Severity.Error);
        }
        finally
        {
            IsActionLoading = false;
        }
    }

    private void NavigateToLogin()
    {
        var returnUrl = Uri.EscapeDataString(Navigation.Uri);
        Navigation.NavigateTo($"/login?returnUrl={returnUrl}");
    }
}
