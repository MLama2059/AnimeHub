@page "/anime/{Id:int}"
@using AnimeHub.Shared.Models.Enums
@using AnimeHubClient.Services
@using Microsoft.AspNetCore.Components.Authorization
@inject IAnimeService AnimeService
@inject IWatchlistService WatchlistService
@inject IConfiguration Configuration
@inject ISnackbar Snackbar
@inject AuthenticationStateProvider AuthenticationStateProvider

@if (IsLoading)
{
    <div class="py-4 text-center"><MudProgressCircular Indeterminate="true" /></div>
}
else if (Anime == null)
{
    <MudAlert Severity="Severity.Error" Class="mt-5">
        <MudText Typo="Typo.h5">Anime Not Found</MudText>
        <MudText>The requested anime ID (@Id) could not be retrieved.</MudText>
    </MudAlert>
}
else
{
    <MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-5">
        <MudGrid Spacing="4">
            @* --- Left Column: Image and Details --- *@
            <MudItem xs="12" md="4" lg="3">
                <MudPaper Elevation="8" Class="pa-2">
                    <img src="@(Configuration["ApiBaseUrl"]?.ToString() + Anime.ImageUrl)" alt="@Anime.Title" style="width:100%; height:auto; border-radius:4px;" />
                </MudPaper>

                <MudList T="string" Class="mt-4" Dense="true">
                    <MudListItem Icon="@Icons.Material.Filled.CalendarMonth">
                        <MudText Typo="Typo.subtitle1" Class="fw-bold">Premiered:</MudText>
                        @Anime.Season @Anime.PremieredYear
                    </MudListItem>
                    <MudListItem Icon="@Icons.Material.Filled.StarRate">
                        <MudText Typo="Typo.subtitle1" Class="fw-bold">Rating:</MudText>
                        @(Anime.Rating.HasValue? Anime.Rating.ToString() : "N/A")
                    </MudListItem>
                    <MudListItem Icon="@Icons.Material.Filled.Movie">
                        <MudText Typo="Typo.subtitle1" Class="fw-bold">Episodes:</MudText>
                        @(Anime.Episodes.HasValue? Anime.Episodes.ToString() : "N/A")
                    </MudListItem>
                    <MudListItem Icon="@Icons.Material.Filled.Update">
                        <MudText Typo="Typo.subtitle1" Class="fw-bold">Status:</MudText> @Anime.Status
                    </MudListItem>
                    <MudListItem Icon="@Icons.Material.Filled.CameraRoll">
                        <MudText Typo="Typo.subtitle1" Class="fw-bold">Studios:</MudText>
                        @if (Anime.Studios != null && Anime.Studios.Any())
                        {
                            @foreach (var studio in Anime.Studios)
                            {
                                <MudText Typo="Typo.body2">@studio</MudText>
                            }
                        }
                        else
                        {
                            <MudText Typo="Typo.body2">N/A</MudText>
                        }

                    </MudListItem>
                    @* <MudListItem Icon="@Icons.Material.Filled.Category">
                        <MudText Typo="Typo.subtitle1" Class="fw-bold">Category:</MudText>
                        @Anime.CategoryName
                    </MudListItem> *@
                </MudList>
            </MudItem>

            @* --- Right Column: Header, Description, Reviews --- *@
            <MudItem xs="12" md="8" lg="9">
                <MudText Typo="Typo.h3" Class="fw-bold mb-1">@Anime.Title</MudText>
                <MudText Typo="Typo.subtitle1" Class="text-muted mb-3">@Anime.CategoryName</MudText>

                @* Watchlist UI block *@
                <MudStack Row="true" Spacing="2" Class="mb-4 align-items-center">
                    @if (!IsAuthenticated)
                    {
                        <MudButton Variant="Variant.Filled" Color ="Color.Dark" Disabled="true" StartIcon="@Icons.Material.Filled.Lock">
                            Log In to Add to Watchlist
                        </MudButton>
                    }
                    else if (CurrentWatchStatus.HasValue)
                    {
                        <MudSelect T="WatchStatus"
                                   Value="@CurrentWatchStatus.Value"
                                   ValueChanged="OnStatusChangeAsync"
                                   Label="My Status"
                                   Variant="Variant.Filled"
                                   Disabled="@IsLoading"
                                   Style="min-width: 180px;">
                            @foreach (var status in Statuses)
                            {
                                <MudSelectItem Value="@status">@status.ToString()</MudSelectItem>
                            }
                        </MudSelect>

                        <MudButton @onclick="ToggleWatchlistAsync"
                                   StartIcon="@Icons.Material.Filled.BookmarkRemove"
                                   Variant="Variant.Filled"
                                   Color="Color.Error"
                                   Disabled="@IsLoading">
                            Remove
                        </MudButton>
                    }
                    else
                    {
                        <MudButton @onclick="ToggleWatchlistAsync"
                                   StartIcon="@Icons.Material.Filled.BookmarkAdd"
                                   Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   Disabled="@IsLoading">
                            Add to Watchlist
                        </MudButton>
                    }
                </MudStack>
                
                @* Genres Chip Group *@
                <MudText Typo="Typo.subtitle1" Class="fw-bold mb-2">Genres</MudText>
                <MudChipSet T="Color" Class="mb-4">
                    @if (Anime.Genres != null && Anime.Genres.Any())
                    {
                        @foreach (var genre in Anime.Genres)
                        {
                            <MudChip Text="@genre" Color="Color.Primary" Variant="Variant.Filled" />
                        }
                    }
                    else
                    {
                        <MudText Typo="Typo.body2">N/A</MudText>
                    }
                </MudChipSet>

                @* Trailer *@
                @if (!string.IsNullOrEmpty(Anime.TrailerUrl))
                {
                    // Use a variable to safely get the absolute URLs for trailer/poster
                    string trailerBaseUrl = Configuration["ApiBaseUrl"]?.ToString() ?? "";
                    string fullTrailerUrl = trailerBaseUrl + Anime.TrailerUrl;
                    string fullPosterUrl = trailerBaseUrl + Anime.TrailerPosterUrl;

                    <MudText Typo="Typo.h5" Class="mt-4 mb-2 fw-bold">Official Trailer</MudText>
                    <MudPaper Elevation="4" Class="mb-4 pa-1" Style="max-width: 300px;">
                        <video controls style="width: 100%; height: auto; border-radius: 4px;"
                               poster="@fullPosterUrl">
                            <source src="@fullTrailerUrl" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>
                    </MudPaper>
                }

                <MudText Typo="Typo.h5" Class="mt-4 fw-bold">Synopsis</MudText>
                <MudDivider Class="my-2" />
                <MudText Typo="Typo.body1" Style="white-space: pre-wrap;">@Anime.Description</MudText>

                @* --- User Review Section Placeholder --- *@
                <RatingSection AnimeId="@Id" />
            </MudItem>
        </MudGrid>
    </MudContainer>
}

@code {
    [Parameter]
    public int Id { get; set; }
    private bool IsLoading { get; set; } = true;

    private AnimeReadDto? Anime;
    private WatchStatus? CurrentWatchStatus = null;
    private bool IsAuthenticated;

    // Enum to hold the watching statuses for the dropdown
    private List<WatchStatus> Statuses = Enum.GetValues<WatchStatus>().ToList();

    protected override async Task OnInitializedAsync()
    {
        await LoadAnime();
    }

    private async Task LoadAnime()
    {
        IsLoading = true;
        Anime = null;
        CurrentWatchStatus = null;

        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        IsAuthenticated = authState.User.Identity?.IsAuthenticated ?? false;

        try
        {
            Anime = await AnimeService.GetAnimeByIdAsync(Id);

            if (Anime != null && IsAuthenticated)
            {
                CurrentWatchStatus = await WatchlistService.GetWatchStatusAsync(Id);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error fetching anime details: {ex.Message}", Severity.Error);
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task ToggleWatchlistAsync()
    {
        if (!IsAuthenticated) return;

        IsLoading = true;

        try
        {
            if (CurrentWatchStatus.HasValue)
            {
                var success = await WatchlistService.RemoveFromWatchlistAsync(Id);
                if (success)
                {
                    CurrentWatchStatus = null;
                    Snackbar.Add("Anime removed from watchlist.", Severity.Success);
                }
                else
                {
                    Snackbar.Add("Failed to removed from watchlist.", Severity.Error);
                }
            }
            else
            {
                var success = await WatchlistService.AddToWatchlistAsync(Id);
                if (success)
                {
                    CurrentWatchStatus = await WatchlistService.GetWatchStatusAsync(Id);
                    Snackbar.Add("Anime added to watchlist!", Severity.Success);
                }
                else
                {
                    Snackbar.Add("Failed to add to watchlist. It might already exist.", Severity.Error);
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Watchlist error: {ex.Message}", Severity.Error);
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task OnStatusChangeAsync(WatchStatus newStatus)
    {
        if (!IsAuthenticated || !CurrentWatchStatus.HasValue || CurrentWatchStatus == newStatus) return;

        IsLoading = true;

        try
        {
            var success = await WatchlistService.UpdateWatchStatusAsync(Id, newStatus);

            if (success)
            {
                CurrentWatchStatus = newStatus;
                Snackbar.Add($"Watch status updated to {newStatus}!", Severity.Success);
            }
            else
            {
                Snackbar.Add("Failed to update status.", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error updating status: {ex.Message}", Severity.Error);
        }
        finally
        {
            IsLoading = false;
        }
    }
}
