@page "/anime"
@using AnimeHub.Shared.Models.Dtos
@using AnimeHub.Shared.Models.Dtos.Anime
@using AnimeHubClient.Shared
@using Microsoft.AspNetCore.WebUtilities
@inject HttpClient Http
@inject IDialogService Dialog
@inject ISnackbar Snackbar

@if (IsLoading)
{
    <div class="py-4 text-center"><MudProgressCircular Indeterminate="true" /></div>
}
else
{
    <div class="card shadow border-0 mt-4">
        <div class="card-header bg-black bg-gradient m-lg-0 py-3">
            <div class="row">
                <div class="col-12 text-center">
                    <h2 class="text-white py-2">Anime List</h2>
                </div>
            </div>
        </div>
        <div class="card-body p-4">
            <div class="col-12 text-end">
                <a href="anime/create" class="btn btn-secondary"><i class="bi bi-plus-square"></i> Add New Anime</a>
            </div>
        </div>
        @if (AnimesList != null && AnimesList.Any())
        {
            <div class="table-responsive">
                <table class="table table-bordered table-striped">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Episodes</th>
                            <th>Priemered</th>
                            <th>Status</th>
                            <th>Category</th>
                            <th>Rating</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var anime in AnimesList)
                        {
                            <tr>
                                <td>@anime.Title</td>
                                <td>@anime.Episodes</td>
                                <td>@anime.Season @anime.PremieredYear</td>
                                <td>@anime.Status</td>
                                <td>@anime.CategoryName</td>
                                <td>@anime.Rating</td>

                                <td class="text-center align-middle">
                                    <div class="d-flex justify-content-center gap-2">
                                        <a href="@($"anime/update/{anime.Id}")" class="btn btn-primary btn-sm d-flex align-items-center"><i class="bi bi-pencil-square me-1"></i> Edit</a>
                                        <button class="btn btn-danger btn-sm d-flex align-items-center" @onclick="() => DeleteAnime(anime.Id)"><i class="bi bi-trash me-1"></i> Delete</button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>

                @* --- Pagination Controls --- *@
                <div class="d-flex justify-content-center mt-3">
                    <nav>
                        <ul class="pagination">
                            @* Previous Button *@
                            <li class="page-item @(Metadata.HasPrevious ? null : "disabled")">
                                <button class="page-link"
                                        @onclick="() => ChangePage(Metadata.CurrentPage - 1)"
                                        disabled="@(!Metadata.HasPrevious)">
                                    Previous
                                </button>
                            </li>

                            @* Page Status Display *@
                            <li class="page-item disabled">
                                <span class="page-link">
                                    Page @Metadata.CurrentPage of @Metadata.TotalPages (@Metadata.TotalCount items)
                                </span>
                            </li>

                            @* Next Button *@
                            <li class="page-item @(Metadata.HasNext ? null : "disabled")">
                                <button class="page-link"
                                        @onclick="() => ChangePage(Metadata.CurrentPage + 1)"
                                        disabled="@(!Metadata.HasNext)">
                                    Next
                                </button>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        }
    </div>
}

@code {
    private bool IsLoading { get; set; } = true;
    // private List<AnimeReadDto>? Animes;
    private List<AnimeListReadDto> AnimesList = new();
    private PagedListMetadata Metadata = new();
    private int CurrentPage = 1;
    private int PageSize = 10;

    protected override async Task OnInitializedAsync()
    {
        await LoadAnimes();
    }

    private async Task LoadAnimes()
    {
        IsLoading = true;
        StateHasChanged();
        try
        {
            // Build the Query String
            var queryParams = new Dictionary<string, string?>
            {
                {"pageNumber", CurrentPage.ToString()},
                {"pageSize", PageSize.ToString()}
            };

            // Construct the full URL: api/anime?pageNumber=1&pageSize=10...
            var uri = QueryHelpers.AddQueryString("api/anime", queryParams);

            // Execute the HTTP request
            var response = await Http.GetAsync(uri);
            response.EnsureSuccessStatusCode();

            // Read Pagination Metadata from the Header
            if (response.Headers.TryGetValues("X-Pagination", out IEnumerable<string>? headerValues))
            {
                var header = headerValues.FirstOrDefault();
                if (!string.IsNullOrWhiteSpace(header))
                {
                    // LOG 1: Log the raw JSON header string
                    Console.WriteLine($"Raw X-Pagination Header: {header}");

                    Metadata = System.Text.Json.JsonSerializer.Deserialize<PagedListMetadata>(header,
                        new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true })
                        ?? new PagedListMetadata();

                    // LOG 2: Log the deserialized values
                    Console.WriteLine($"Metadata TotalPages: {Metadata.TotalPages}, HasNext: {Metadata.HasNext}");
                }
            }

            // Read the Anime List from the Body
            AnimesList = await response.Content.ReadFromJsonAsync<List<AnimeListReadDto>>()
                        ?? new List<AnimeListReadDto>();
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error fetching category data: {ex.Message}");
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }

    private async Task DeleteAnime(int id)
    {
        var parameters = new DialogParameters<ConfirmationDialog>
        {
            { x => x.ContentText, "Are you sure you want to delete?"  },
            { x => x.ButtonText, "Delete" }
        };

        var options = new DialogOptions
        {
            CloseButton = true,
            MaxWidth = MaxWidth.ExtraLarge,
            FullWidth = false,
        };

        var dialog = await Dialog.ShowAsync<ConfirmationDialog>("Confirm Delete", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            // Call API to delete
            var response = await Http.DeleteAsync($"api/anime/{id}");
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Anime deleted successfully!", Severity.Success);
                await LoadAnimes(); // Reload list
            }
            else
            {
                Snackbar.Add("Failed to delete anime.", Severity.Error);
            }
        }
    }

    private async Task ChangePage(int newPage)
    {
        // 1. Basic boundary check (though Metadata.HasNext/HasPrevious handles most of it)
        if (newPage < 1 || newPage > Metadata.TotalPages)
        {
            return;
        }

        // 2. Update the state variable
        CurrentPage = newPage;

        // 3. Reload the data from the API
        await LoadAnimes();
    }
}
