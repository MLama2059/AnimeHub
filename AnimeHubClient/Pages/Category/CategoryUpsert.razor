@page "/admin/categories/create"
@page "/admin/categories/update/{Id:int}"
@using AnimeHub.Shared.Models.Dtos.Category
@using AnimeHubClient.Services
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject ICategoryService CategoryService

@if (IsLoading)
{
    <div class="py-4 text-center"><MudProgressCircular Indeterminate="true" /></div>

}
else
{
    <MudCard Elevation="4" Class="mt-4">
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Align="Align.Center" Typo="Typo.h4" Class="fw-bold">@(Id > 0 ? "Update" : "Create") Category</MudText>
            </CardHeaderContent>
        </MudCardHeader>
        <MudCardContent>
            <EditForm Model="Category" FormName="CategoryUpsertForm" OnValidSubmit="UpsertCategory">
                <DataAnnotationsValidator />

                <MudTextField Variant="Variant.Outlined" Label="Category Name" @bind-Value="Category.Name" For="@(() => Category.Name)" Class="mb-4" />

                <MudCardActions>
                    <MudGrid Justify="Justify.Center" Class="px-2">
                        <MudItem xs="12" sm="6">
                            <MudButton ButtonType="ButtonType.Submit" StartIcon="@Icons.Material.Filled.LibraryAddCheck" Variant="Variant.Filled" Color="Color.Primary" FullWidth="true" Disabled="@IsLoading">@(Id > 0 ? "Update" : "Create")</MudButton>
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudButton Href="/admin/categories" StartIcon="@Icons.Material.Filled.ArrowCircleLeft" Variant="Variant.Filled" Color="Color.Default" FullWidth="true" Disabled="@IsLoading">Back to List</MudButton>
                        </MudItem>
                    </MudGrid>
                </MudCardActions>
            </EditForm>
        </MudCardContent>
    </MudCard>
}

@code {
    [Parameter]
    public int Id { get; set; }

    // Single form model, can be either Create or Update DTO
    private CategoryUpdateDto Category { get; set; } = new();

    private bool IsLoading { get; set; } = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadCategory();
        IsLoading = false;
        StateHasChanged();
    }

    private async Task LoadCategory()
    {
        if (Id > 0)
        {
            var result = await CategoryService.GetCategoryByIdAsync(Id);
            if (result != null)
            {
                Category.Id = result.Id;
                Category.Name = result.Name;
            }
        }
    }

    private async Task UpsertCategory()
    {
        IsLoading = true;
        StateHasChanged();

        bool success = false;

        try
        {
            if (Id == 0)
            {
                // Create
                var createDto = new CategoryCreateDto { Name = Category.Name };
                success = await CategoryService.CreateCategoryAsync(createDto);
            }
            else
            {
                // Update
                success = await CategoryService.UpdateCategoryAsync(Category);
            }

            // Handle Result
            if (success)
            {
                Snackbar.Add($"Category {(Id > 0 ? "updated" : "created")} successfully.", Severity.Success);
                Navigation.NavigateTo("/admin/categories");
            }
            else
            {
                Snackbar.Add($"Failed to {(Id > 0 ? "update" : "create")} category.", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"An unexpected error occured: {ex.Message}", Severity.Error);
        }
        finally
        {
            IsLoading = false;
            Navigation.NavigateTo("/admin/categories"); 
        }
    }
}
