@page "/propose-anime"
@using AnimeHub.Shared.Models.Dtos.AnimeProposal
@using AnimeHub.Shared.Models.Dtos.Studio
@using AnimeHub.Shared.Models.Enums
@using AnimeHubClient.Services
@inject ILookUpService LookUpService
@inject IAnimeProposalService ProposalService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation

<MudCard Elevation="4" Class="mt-4">
    <MudCardHeader>
        <CardHeaderContent>
            <MudText Align="Align.Center" Typo="Typo.h4" Class="fw-bold">Propose New Anime</MudText>
            <MudText Align="Align.Center" Typo="Typo.body2">Fill out the details below. An admin will review your submission.</MudText>
        </CardHeaderContent>
    </MudCardHeader>
    <MudCardContent>
        <EditForm Model="Proposal" OnValidSubmit="SubmitProposal">
            <DataAnnotationsValidator />

            <MudTextField Variant="Variant.Outlined" Label="Anime Title" @bind-Value="Proposal.Title" For="@(() => Proposal.Title)" Class="my-3" />
            <MudTextField Variant="Variant.Outlined" Label="Description" Lines="3" @bind-Value="Proposal.Description" For="@(() => Proposal.Description)" Class="my-3" />

            <MudGrid>
                <MudItem xs="12" sm="6">
                    <MudNumericField T="double?" Variant="Variant.Outlined" Label="Rating" @bind-Value="Proposal.Rating" Min="0.0" Max="10.0" For="@(() => Proposal.Rating)" Class="my-3" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudNumericField T="int?" Variant="Variant.Outlined" Label="Episodes" @bind-Value="Proposal.Episodes" For="@(() => Proposal.Episodes)" Class="my-3" />
                </MudItem>
            </MudGrid>

            <MudGrid>
                <MudItem xs="12" sm="6">
                    <MudSelect T="int?" Label="Season" Variant="Variant.Outlined" @bind-Value="Proposal.Season" For="@(() => Proposal.Season)" Class="my-3">
                        @foreach (var seasonValue in Enum.GetValues(typeof(Season)))
                        {
                            <MudSelectItem T="int" Value="@((int)seasonValue)">@seasonValue.ToString()</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudNumericField T="int?" Variant="Variant.Outlined" Label="Premiered Year" Min="1900" Max="2100" @bind-Value="Proposal.PremieredYear" For="@(() => Proposal.PremieredYear)" Class="my-3" />
                </MudItem>
            </MudGrid>

            @* Categories *@
            <MudSelect T="int?" Label="Category" Variant="Variant.Outlined" @bind-Value="Proposal.CategoryId" For="@(() => Proposal.CategoryId)" Class="my-3">
                @foreach (var category in Categories)
                {
                    <MudSelectItem T="int" Value="@category.Id">@category.Name</MudSelectItem>
                }
            </MudSelect>

            @* Studios *@
            <MudSelect T="int" Label="Studios" Variant="Variant.Outlined" SelectedValues="Proposal.StudioIds"
                       SelectedValuesChanged="@(vals => Proposal.StudioIds = new List<int>(vals))"
                       MultiSelection="true" Clearable="true"
                       ToStringFunc="@(new Func<int, string>(ConvertStudioIdToName))" Class="my-3">
                @foreach (var studio in Studios)
                {
                    <MudSelectItem T="int" Value="@studio.Id">@studio.Name</MudSelectItem>
                }
            </MudSelect>

            @* Genres *@
            <MudPaper Elevation="2" Class="p-3 mt-3">
                <MudText Typo="Typo.subtitle1" Class="mb-2">Genres</MudText>
                <MudGrid>
                    @foreach (var genre in Genres)
                    {
                        <MudItem xs="6" sm="4" md="3" lg="2">
                            <MudCheckBox T="bool" Label="@genre.Name" Dense="true" Size="Size.Small" Color="Color.Primary"
                                         Value="@Proposal.GenreIds.Contains(genre.Id)"
                                         ValueChanged="e => ToggleGenre(genre.Id, e)" />
                        </MudItem>
                    }
                </MudGrid>
            </MudPaper>

            @* Image Upload *@
            <MudFileUpload T="IBrowserFile" OnFilesChanged="OnImageFileSelected" Class="mt-3">
                <ActivatorContent>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Image">
                        Upload Cover Image
                    </MudButton>
                </ActivatorContent>
            </MudFileUpload>

            @if (!string.IsNullOrEmpty(PreviewImageUrl))
            {
                <MudImage Src="@PreviewImageUrl" Alt="Preview" Elevation="25" Class="rounded-lg ma-4 d-block mx-auto" Style="max-height:200px; max-width: 100%;" />
            }

            <MudCardActions Class="py-4">
                <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Success" FullWidth="true" Disabled="@IsLoading">
                    @if (IsLoading)
                    {
                        <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                        <MudText Class="ms-2">Submitting...</MudText>
                    }
                    else
                    {
                        <MudText>Submit Proposal</MudText>
                    }
                </MudButton>
            </MudCardActions>

        </EditForm>
    </MudCardContent>
</MudCard>

@code {
    private AnimeProposalCreateDto Proposal { get; set; } = new() { GenreIds = new List<int>(), StudioIds = new List<int>() };
    private List<CategoryReadDto> Categories { get; set; } = new();
    private List<GenreReadDto> Genres { get; set; } = new();
    private List<StudioReadDto> Studios { get; set; } = new();

    private bool IsLoading { get; set; } = false;
    private IBrowserFile? SelectedImageFile;
    private string? PreviewImageUrl;

    protected override async Task OnInitializedAsync()
    {
        var categoriesTask = LookUpService.GetCategoriesAsync();
        var genresTask = LookUpService.GetGenresAsync();
        var studiosTask = LookUpService.GetStudiosAsync();

        await Task.WhenAll(categoriesTask, genresTask, studiosTask);

        Categories = categoriesTask.Result?.OrderBy(c => c.Name).ToList() ?? new();
        Genres = genresTask.Result?.OrderBy(g => g.Name).ToList() ?? new();
        Studios = studiosTask.Result?.OrderBy(s => s.Name).ToList() ?? new();
    }

    private async Task SubmitProposal()
    {
        IsLoading = true;

        try
        {
            // 1. Upload Temp Image if selected
            if (SelectedImageFile != null)
            {
                var content = new MultipartFormDataContent();
                var fileContent = new StreamContent(SelectedImageFile.OpenReadStream(5 * 1024 * 1024)); // Limit to 5MB
                fileContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue(SelectedImageFile.ContentType);
                content.Add(fileContent, "file", SelectedImageFile.Name);

                // Call the service we made earlier
                var tempPath = await ProposalService.UploadTempFileAsync(content, "image");
                if (string.IsNullOrEmpty(tempPath))
                {
                    Snackbar.Add("Failed to upload image.", Severity.Error);
                    IsLoading = false;
                    return;
                }
                Proposal.ImageUrl = tempPath;
            }

            // 2. Submit Data
            var result = await ProposalService.CreateProposalAsync(Proposal);
            if (result != null)
            {
                Snackbar.Add("Proposal submitted successfully!", Severity.Success);
                Navigation.NavigateTo("/");
            }
            else
            {
                Snackbar.Add("Failed to submit proposal.", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Image upload failed: {ex.Message}", Severity.Error);
        }
        finally
        {
            IsLoading = false;
        }
    }

    // --- Helper Methods (Same as Admin form) ---

    private void ToggleGenre(int genreId, bool isChecked)
    {
        if (isChecked && !Proposal.GenreIds.Contains(genreId)) Proposal.GenreIds.Add(genreId);
        else if (!isChecked) Proposal.GenreIds.Remove(genreId);
    }

    private string ConvertStudioIdToName(int id) => Studios?.FirstOrDefault(s => s.Id == id)?.Name ?? $"ID {id}";

    private async Task OnImageFileSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file != null)
        {
            var buffer = new byte[file.Size];
            await file.OpenReadStream(5 * 1024 * 1024).ReadAsync(buffer);
            PreviewImageUrl = $"data:{file.ContentType};base64,{Convert.ToBase64String(buffer)}";
            SelectedImageFile = file;
        }
    }
}