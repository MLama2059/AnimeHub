@page "/proposal-list"
@using AnimeHub.Shared.Models.Enums
@using AnimeHubClient.Services
@inject IAnimeProposalService ProposalService
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<MudCard Elevation="4" Class="mt-4">
    <MudCardHeader>
        <CardHeaderContent>
            <MudText Align="Align.Center" Typo="Typo.h4" Class="fw-bold">Anime Proposals</MudText>
        </CardHeaderContent>
    </MudCardHeader>
    <MudCardContent>
        <MudTable Items="@Proposals" Hover="true" Bordered="true" Striped="true" Loading="@IsLoading">
            <HeaderContent>
                <MudTh>Title</MudTh>
                <MudTh>Submitted By</MudTh>
                <MudTh>Status</MudTh>
                <MudTh Style="text-align: center;">Actions</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Title">@context.Title</MudTd>
                <MudTd DataLabel="Submitted By">User ID: @context.UserId</MudTd>
                <MudTd DataLabel="Status">
                    @if (context.ProposalStatus == ProposalStatus.Pending) // Pending
                    {
                        <MudChip T="string" Color="Color.Warning" Size="Size.Small">Pending</MudChip>
                    }
                    else if (context.ProposalStatus == ProposalStatus.Approved) // Approved
                    {
                        <MudChip T="string" Color="Color.Success" Size="Size.Small">Approved</MudChip>
                    }
                    else // Rejected
                    {
                        <MudChip T="string" Color="Color.Error" Size="Size.Small">Rejected</MudChip>
                    }
                </MudTd>
                <MudTd DataLabel="Actions" Style="text-align:center;">
                    @if (context.ProposalStatus == ProposalStatus.Pending) // Only show actions for Pending
                    {
                        <MudButton OnClick="@(() => OpenDetails(context))" Variant="Variant.Filled" Color="Color.Primary" Size="Size.Small" StartIcon="@Icons.Material.Filled.Visibility">Review</MudButton>
                    }
                    else
                    {
                        <MudButton OnClick="@(() => OpenDetails(context))" Variant="Variant.Filled" Color="Color.Primary" Size="Size.Small" StartIcon="@Icons.Material.Filled.History">View Details</MudButton>
                    }
                </MudTd>
            </RowTemplate>
            <NoRecordsContent>
                <MudText>No pending proposals.</MudText>
            </NoRecordsContent>
        </MudTable>
    </MudCardContent>
</MudCard>

@code {
    private IEnumerable<AnimeProposal> Proposals = new List<AnimeProposal>();
    private bool IsLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadProposals();
    }

    private async Task LoadProposals()
    {
        IsLoading = true;
        Proposals = (await ProposalService.GetAllProposalsAsync()).OrderBy(x => x.ProposalStatus).ThenBy(x => x.Id);
        IsLoading = false;
    }

    private async Task OpenDetails(AnimeProposal proposal)
    {
        var parameters = new DialogParameters<ProposalDetailsDialog>
        {
            { x => x.Proposal, proposal }
        };

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };

        var dialog = await DialogService.ShowAsync<ProposalDetailsDialog>("Proposal Details", parameters, options);
        var result = await dialog.Result;

        // If the dialog returns true (meaning an action was taken), reload the list
        if (!result.Canceled && result.Data is bool data && data == true)
        {
            await LoadProposals();
        }
    }
}

