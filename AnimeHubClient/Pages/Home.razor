@page "/"
@using AnimeHub.Shared.Models.Dtos
@using AnimeHub.Shared.Models.Dtos.Anime
@using AnimeHubClient.Services
@using MudBlazor
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject IAnimeService AnimeService
@inject ILookUpService LookUpService

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudGrid Justify="Justify.Center">

        @* --- 1. HERO SECTION (Using MudCarousel) --- *@
        <MudItem xs="12">
            <div style="position:relative; height:84vh;">
                <MudCarousel Class="mud-carousel-custom" Style="height:84vh" NextIcon="@Icons.Material.Outlined.ArrowCircleRight" PreviousIcon="@Icons.Material.Filled.ArrowCircleLeft" ShowArrows="true" AutoCycle="true" TData="object">
                    <MudCarouselItem Transition="Transition.Fade">
                        <div class="hero-image-overlay" style="background-image: url('/images/hero1.jpg');"></div>
                    </MudCarouselItem>
                    <MudCarouselItem Transition="Transition.Fade">
                        <div class="hero-image-overlay" style="background-image: url('/images/hero6.jpg');"></div>
                    </MudCarouselItem>
                    <MudCarouselItem Transition="Transition.Fade">
                        <div class="hero-image-overlay" style="background-image: url('/images/hero7.jpg');"></div>
                    </MudCarouselItem>
                    <MudCarouselItem Transition="Transition.Fade">
                        <div class="hero-image-overlay" style="background-image: url('/images/hero4.jpg');"></div>
                    </MudCarouselItem>
                </MudCarousel>

                @* Overlay section *@
                <div class="hero-content-overlay">
                    <div class="hero-content">
                        <h1 class="hero-title">Welcome to <span class="highlight">AnimeHub</span></h1>
                        <p class="hero-subtitle">Your destination for all things anime. Discover, rate, and explore a world of stories.</p>
                        <div class="hero-cta">
                            <MudButton Href="animes"
                                       Variant="Variant.Filled"
                                       Color="Color.Primary"
                                       Size="Size.Large"
                                       Class="hero-cta-button">
                                Browse Anime
                            </MudButton>
                            <MudButton Href="anime-catalog?sort=trending"
                                       Variant="Variant.Outlined"
                                       Color="Color.Inherit"
                                       Size="Size.Large"
                                       Class="hero-cta-button hero-cta-outline-light">
                                <MudIcon Icon="@Icons.Material.Filled.Whatshot" Class="me-1" Size="Size.Small" />Trending
                            </MudButton>
                        </div>
                    </div>
                </div>
            </div>
            
        </MudItem>
        @* ----------------------------------------------------------------- *@

        @* --- 2. TOP RATED ANIME SECTION (Using MudPaper for consistency) --- *@
        <MudItem xs="12" Class="pt-5">
            <MudPaper Class="pa-6 section-paper" Elevation="4">
                <MudText Typo="Typo.h5" Class="fw-bold mb-5 section-title" Align="Align.Center">Top Rated Anime</MudText>

                @if (IsLoading)
                {
                    <MudGrid Justify="Justify.Center">
                        @for (int i = 0; i < 6; i++)
                        {
                            <MudItem lg="2" md="3" sm="4" xs="6" Class="d-flex justify-content-center">
                                <AnimeCardSkeleton />
                            </MudItem>
                        }
                    </MudGrid>
                }
                else if (TopRatedAnimes != null && TopRatedAnimes.Any())
                {
                    <MudGrid Justify="Justify.Center" Spacing="4">
                        @foreach (var anime in TopRatedAnimes)
                        {
                            <MudItem lg="2" md="3" sm="4" xs="6" Class="d-flex justify-content-center">
                                @* Assuming AnimeCard is a component that renders the card UI *@
                                <AnimeCard Anime="anime" />
                            </MudItem>
                        }
                    </MudGrid>
                }
                else
                {
                    <MudText Align="Align.Center">No top-rated anime to display.</MudText>
                }
            </MudPaper>
        </MudItem>
        @* ----------------------------------------------------------------- *@

        @* --- 3. CATEGORY & GENRE SECTIONS (Using MudButtons) --- *@
        <MudItem xs="12" Class="mt-8">
            <MudText Typo="Typo.h5" Class="fw-bold mb-4" Align="Align.Center">Browse by Category</MudText>
            <MudGrid Justify="Justify.Center" Spacing="2">
                @if (Categories != null && Categories.Any())
                {
                    @foreach (var category in Categories)
                    {
                        <MudItem lg="2" md="3" sm="4" xs="6">
                            <MudButton Href="@($"category/{category.Id}")"
                                       Variant="Variant.Outlined"
                                       Color="Color.Secondary"
                                       FullWidth="true"
                                       Class="category-genre-button">
                                @category.Name
                            </MudButton>
                        </MudItem>
                    }
                }
                else
                {
                    <MudItem xs="12"><MudText Align="Align.Center">No categories to display.</MudText></MudItem>
                }
            </MudGrid>
        </MudItem>

        <MudItem xs="12" Class="mt-8 mb-8">
            <MudText Typo="Typo.h5" Class="fw-bold mb-4" Align="Align.Center">Browse by Genre</MudText>
            <MudGrid Justify="Justify.Center" Spacing="2">
                @if (Genres != null && Genres.Any())
                {
                    @foreach (var genre in Genres)
                    {
                        <MudItem lg="2" md="3" sm="4" xs="6">
                            <MudButton Href="@($"genre/{genre.Id}")"
                                       Variant="Variant.Outlined"
                                       Color="Color.Secondary"
                                       FullWidth="true"
                                       Class="category-genre-button">
                                @genre.Name
                            </MudButton>
                        </MudItem>
                    }
                }
                else
                {
                    <MudItem xs="12"><MudText Align="Align.Center">No genres to display.</MudText></MudItem>
                }
            </MudGrid>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    private bool IsLoading { get; set; } = true;
    private List<AnimeListReadDto>? TopRatedAnimes { get; set; }
    private List<CategoryReadDto>? Categories { get; set; }
    private List<GenreReadDto>? Genres { get; set; }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Concurrent data fetching
            var topRatedAnimesTask = AnimeService.GetTopRatedAnimesAsync();
            var categoriesTask = LookUpService.GetCategoriesAsync();
            var genresTask = LookUpService.GetGenresAsync();

            await Task.WhenAll(topRatedAnimesTask, categoriesTask, genresTask);

            TopRatedAnimes = topRatedAnimesTask.Result;
            Categories = categoriesTask.Result;
            Genres = genresTask.Result;
        }
        catch (Exception ex)
        {
            // Use Snackbar for user feedback on error, consistent with admin pages
            Snackbar.Add($"Error loading home page data: {ex.Message}", Severity.Error);
            Console.WriteLine($"An error occurred while fetching home page data: {ex.Message}");
        }
        finally
        {
            IsLoading = false;
        }
    }
}